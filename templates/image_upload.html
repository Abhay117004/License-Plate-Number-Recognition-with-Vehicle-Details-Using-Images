<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car OCR & Vehicle Lookup</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .upload-area.drag-over { border-color:#3b82f6;background:#eff6ff; }
        .loader {
            width: 64px;
            height: 64px;
            border: 6px solid #d1d5db;
            border-bottom-color: #3b82f6;
            border-radius: 50%;
            display: inline-block;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-6">

<div class="w-full max-w-6xl bg-white rounded-2xl shadow-lg overflow-hidden">
    <header class="bg-blue-600 text-white p-8 text-center">
        <h1 class="text-4xl font-bold">Car OCR & Vehicle Lookup</h1>
        <p class="mt-2 text-blue-200 text-lg">Upload an image to extract the number plate and fetch car details</p>
    </header>

    <main class="p-8 md:p-10 grid md:grid-cols-2 gap-10">
        <!-- Upload & Preview -->
        <div class="flex flex-col space-y-8">
            <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2">1. Upload Image</h2>

            <label id="upload-area" for="image-input"
                   class="upload-area relative flex flex-col items-center justify-center w-full h-80 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer transition-colors duration-200 hover:bg-gray-50">
                <div id="upload-instructions" class="flex flex-col items-center text-gray-500">
                    <svg class="w-14 h-14 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <p class="font-semibold">Click to upload or drag & drop</p>
                    <p class="text-sm">PNG, JPG, or WEBP</p>
                </div>
                <div id="image-preview-container" class="hidden absolute inset-0 p-2">
                    <img id="image-preview" src="#" alt="Preview" class="w-full h-full object-contain rounded-md"/>
                </div>
            </label>
            <input type="file" id="image-input" class="hidden" accept="image/png,image/jpeg,image/webp">

            <div class="flex items-center space-x-6">
                <button id="upload-btn" class="flex-1 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 disabled:bg-gray-400" disabled>Upload</button>
                <button id="ocr-btn" class="flex-1 bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 disabled:bg-gray-400" disabled>Run OCR</button>
                <button id="clear-btn" class="flex-1 bg-gray-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700">Clear</button>
            </div>
        </div>

        <!-- OCR Results -->
        <div class="flex flex-col space-y-8">
            <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2">2. Vehicle Details</h2>

            <div class="relative w-full h-80 bg-gray-50 border border-gray-200 rounded-lg p-4 overflow-auto">
                <div id="loader" class="loader hidden absolute inset-0 flex items-center justify-center"></div>
                <div id="results" class="text-sm text-gray-700 space-y-2">
                    <p class="text-gray-400" id="placeholder">Upload an image and run OCR to see results...</p>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    const uploadArea = document.getElementById('upload-area');
    const imageInput = document.getElementById('image-input');
    const uploadInstructions = document.getElementById('upload-instructions');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const imagePreview = document.getElementById('image-preview');
    const uploadBtn = document.getElementById('upload-btn');
    const ocrBtn = document.getElementById('ocr-btn');
    const clearBtn = document.getElementById('clear-btn');
    const loader = document.getElementById('loader');
    const results = document.getElementById('results');
    const placeholder = document.getElementById('placeholder');

    let currentFile = null;

    // File selection
    imageInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) handleFile(file);
    });

    uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('drag-over'); });
    uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('drag-over'));
    uploadArea.addEventListener('drop', e => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
            imageInput.files = e.dataTransfer.files;
            handleFile(file);
        }
    });

    uploadBtn.addEventListener('click', () => {
        if (!currentFile) return;
        const formData = new FormData();
        formData.append('image', currentFile);

        setLoading(true);
        fetch('/upload', { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                setLoading(false);
                if (data.message) {
                    placeholder.style.display = 'none';
                    results.innerHTML = `<p class="text-green-700">${data.message}</p>`;
                    ocrBtn.disabled = false;
                }
            })
            .catch(err => {
                setLoading(false);
                results.innerHTML = `<p class="text-red-600">Error uploading image.</p>`;
                console.error(err);
            });
    });

    ocrBtn.addEventListener('click', () => {
        setLoading(true);
        results.innerHTML = '';
        placeholder.style.display = 'block';

        fetch('/run-ocr', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                setLoading(false);
                placeholder.style.display = 'none';
                let output = '';
                let plate = "N/A";
                let details = {};

                if (data.message) {
                    const msg = data.message;
                    const plateMatch = msg.match(/[A-Z]{2}\d{1,2}[A-Z]{1,3}\d{3,4}/);
                    if (plateMatch) plate = plateMatch[0];

                    const jsonStart = msg.indexOf('{', msg.indexOf("[INFO]"));
                    if (jsonStart !== -1) {
                        const jsonString = msg.substring(jsonStart).trim();
                        try {
                            const parsed = JSON.parse(jsonString);
                            details = parsed?.result?.extraction_output || {};
                        } catch (e) { console.error("Failed to parse JSON:", e); }
                    }
                }

                output += `
                    <div class="mb-4 p-4 bg-white border rounded-lg shadow">
                        <h2 class="text-xl font-bold text-blue-700 mb-2">Vehicle Summary</h2>
                        <p><strong>Plate:</strong> ${plate}</p>
                        <p><strong>Owner:</strong> ${details.owner_name || 'N/A'}</p>
                        <p><strong>Model:</strong> ${details.manufacturer_model || 'N/A'}</p>
                        <p><strong>Color:</strong> ${details.colour || 'N/A'}</p>
                        <p><strong>Fuel:</strong> ${details.fuel_type || 'N/A'}</p>
                        <p><strong>Registration Date:</strong> ${details.registration_date || 'N/A'}</p>
                        <p><strong>Insurance Validity:</strong> ${details.insurance_validity || 'N/A'}</p>
                        <p><strong>Registered Place:</strong> ${details.registered_place || 'N/A'}</p>
                        <p><strong>Status:</strong> ${details.status_verification || 'N/A'}</p>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Full API Response</h3>
                        <pre class="whitespace-pre-wrap text-gray-800 text-sm bg-gray-100 p-3 rounded-lg overflow-x-auto">
${data.message}
                        </pre>
                    </div>
                `;

                results.innerHTML = output;
            })
            .catch(err => {
                setLoading(false);
                results.innerHTML = `<p class="text-red-600">Error: ${err}</p>`;
                console.error(err);
            });
    });

    clearBtn.addEventListener('click', () => {
        currentFile = null;
        imageInput.value = '';
        uploadInstructions.style.display = 'flex';
        imagePreviewContainer.style.display = 'none';
        imagePreview.src = '#';
        uploadBtn.disabled = true;
        ocrBtn.disabled = true;
        placeholder.style.display = 'block';
        results.innerHTML = '';
        results.appendChild(placeholder);

        fetch('/clear-images', { method: 'POST' })
            .then(res => res.json())
            .then(data => { showPopup(data.message || "Cleared successfully", "success"); })
            .catch(err => { console.error("Failed to clear images:", err); showPopup("Failed to clear images", "error"); });
    });

    function showPopup(message, type = "success") {
        const popup = document.createElement('div');
        popup.textContent = message;
        popup.className = `fixed top-5 right-5 px-4 py-2 rounded shadow-lg z-50 text-white 
            ${type === "success" ? "bg-green-600" : "bg-red-600"}`;
        document.body.appendChild(popup);
        setTimeout(() => popup.remove(), 3000);
    }

    function handleFile(file) {
        currentFile = file;
        const reader = new FileReader();
        reader.onload = e => {
            imagePreview.src = e.target.result;
            uploadInstructions.style.display = 'none';
            imagePreviewContainer.style.display = 'block';
            uploadBtn.disabled = false;
            ocrBtn.disabled = true;
        };
        reader.readAsDataURL(file);
    }

    function setLoading(state) {
        loader.classList.toggle('hidden', !state);
        uploadBtn.disabled = state;
        ocrBtn.disabled = state;
    }
</script>
</body>
</html>
